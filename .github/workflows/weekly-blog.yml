name: Weekly Blog Post Publication

on:
  schedule:
    # Run every Monday at 9:00 AM UTC (4:00 AM EST)
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'package.json'
      - 'netlify.toml'

jobs:
  publish-weekly-blog:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      actions: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci
        npm audit fix --audit-level moderate || true
        
    - name: Generate weekly blog post
      run: |
        echo "Generating blog post for week $(date +%U)"
        node scripts/generate-weekly-post.js
        
    - name: Build website to verify
      run: |
        npm run build
        echo "Build successful - site is ready for deployment"
        
    - name: Check for changes
      id: verify-changed-files
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No new blog post generated this week"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "New blog post generated successfully"
        fi
        
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "HCS Blog Bot"
        git add .
        git commit -m "ðŸ“ Publish weekly blog post - Week $(date +%U) of $(date +%Y)

        Auto-generated blog post for improved SEO and customer engagement.
        
        - Added new blog content
        - Updated site build
        - Ready for Netlify deployment"
        git push origin main
        
    - name: Trigger Netlify Deploy Hook
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        echo "Changes pushed to main branch"
        echo "Netlify will automatically deploy via GitHub integration"
        echo "Blog post will be live within 2-3 minutes"
        
    - name: Create deployment summary
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        echo "## ðŸš€ Weekly Blog Post Published" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Blog post generated successfully**" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Site built and verified**" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Changes committed to main branch**" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Netlify deployment triggered**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ **Live site**: https://hcsroof.com" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“… **Published**: $(date)" >> $GITHUB_STEP_SUMMARY
